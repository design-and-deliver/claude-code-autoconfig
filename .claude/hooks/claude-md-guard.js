#!/usr/bin/env node

/**
 * @name CLAUDE.md Guard
 * @description Detects unauthorized edits to CLAUDE.md and migrates changes to FEEDBACK.md. Only triggers on Claude-initiated edits outside /autoconfig or /sync-claude-md.
 * @trigger PostToolUse on Write to CLAUDE.md
 */

const fs = require('fs');
const path = require('path');

// Read hook input from stdin
let input = '';
process.stdin.setEncoding('utf8');
process.stdin.on('data', chunk => input += chunk);
process.stdin.on('end', () => {
  try {
    const data = JSON.parse(input);
    handleHook(data);
  } catch (err) {
    // Silent exit if no valid input
    process.exit(0);
  }
});

function handleHook(data) {
  // Check if this is a Write to CLAUDE.md
  const filePath = data?.tool_input?.file_path || '';
  if (!filePath.endsWith('CLAUDE.md')) {
    process.exit(0);
  }

  const claudeMdPath = filePath;
  const projectRoot = path.dirname(claudeMdPath);
  const claudeDir = path.join(projectRoot, '.claude');
  const feedbackPath = path.join(claudeDir, 'feedback', 'FEEDBACK.md');

  // Read current CLAUDE.md
  if (!fs.existsSync(claudeMdPath)) {
    process.exit(0);
  }

  const content = fs.readFileSync(claudeMdPath, 'utf8');

  // Parse timestamp from header
  // Format: <!-- AUTO-GENERATED BY /autoconfig at 2026-01-14 11:30:45 UTC â€” Do not edit. -->
  const timestampMatch = content.match(/AUTO-GENERATED.*?at\s+(\d{4}-\d{2}-\d{2}\s+[\d:]+)\s+UTC/);

  if (!timestampMatch) {
    // No timestamp header - not an autoconfig-generated file, skip
    process.exit(0);
  }

  const autoGenTime = new Date(timestampMatch[1] + ' UTC');
  const now = new Date();
  const diffSeconds = (now - autoGenTime) / 1000;

  // If within 3 seconds of autogen, this is a system edit - allow it
  if (diffSeconds <= 3) {
    process.exit(0);
  }

  // User edit detected! Migrate to FEEDBACK.md
  const timestamp = now.toISOString().replace('T', ' ').substring(0, 19);

  const migrationEntry = `

## Manual Edits (auto-captured)

### Captured ${timestamp}

User edited CLAUDE.md directly. Content preserved below for review:

\`\`\`markdown
${content}
\`\`\`

---
`;

  // Append to FEEDBACK.md
  if (fs.existsSync(feedbackPath)) {
    const feedbackContent = fs.readFileSync(feedbackPath, 'utf8');
    fs.writeFileSync(feedbackPath, feedbackContent + migrationEntry);
  }

  // Output friendly message (will be shown to user)
  console.log(`
ðŸ“ Hey! I noticed you edited CLAUDE.md directly.

   I've saved your changes to .claude/feedback/FEEDBACK.md
   Run /sync-claude-md to incorporate your feedback!
`);

  process.exit(0);
}
